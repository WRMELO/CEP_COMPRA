# EXP_003C Master BUY SSOT V8

## Definicao BUY3 e origem
- BUY3 supervisionado diretamente a partir do mapeamento do 5-state teórico:
- `{'BULL': 'BUY2', 'CORR_BULL_NEUTRO': 'BUY2', 'NEUTRO': 'BUY2', 'CORR_NEUTRO_BEAR': 'BUY1', 'BEAR': 'BUY0'}`

## Modelo escolhido e criterio
- chosen_model: `logistic_regression`
- macro_f1_buy3 BVSP: `0.388985`; GSPC: `0.247375`
- balanced_accuracy_buy3 BVSP: `0.491577`; GSPC: `0.426822`

## Matriz de confusao BUY3 (contagens)
```json
{
  "confusion_buy3_counts_bvsp": {
    "BUY2": {
      "BUY2": 688,
      "BUY1": 249,
      "BUY0": 343
    },
    "BUY1": {
      "BUY2": 108,
      "BUY1": 100,
      "BUY0": 179
    },
    "BUY0": {
      "BUY2": 19,
      "BUY1": 25,
      "BUY0": 93
    }
  },
  "confusion_buy3_counts_gspc": {
    "BUY2": {
      "BUY2": 498,
      "BUY1": 542,
      "BUY0": 382
    },
    "BUY1": {
      "BUY2": 37,
      "BUY1": 31,
      "BUY0": 238
    },
    "BUY0": {
      "BUY2": 13,
      "BUY1": 0,
      "BUY0": 63
    }
  }
}
```

## Distribuicoes BUY3 e switches
- BVSP distribuição: `{'BUY2': 815, 'BUY0': 615, 'BUY1': 374}`; switches/ano: `5.727273`
- GSPC distribuição: `{'BUY0': 683, 'BUY1': 573, 'BUY2': 548}`; switches/ano: `5.447894`

## Definicao formal do buy1_intensity_score
- `raw = p_buy2 / (p_buy2 + p_buy0 + 1e-9)` (clamp [0,1])
- se `buy_pred==BUY1`, então `score=raw`; se `BUY2`, `score=1.0`; se `BUY0`, `score=0.0`

## Distribuicao do score em dias BUY1
- BVSP BUY1 score describe: `{'count': 374.0, 'mean': 0.5389871913973205, 'std': 0.2847221433591273, 'min': 0.002790178568619709, '25%': 0.29292238406120624, '50%': 0.557066785771623, '75%': 0.7796985441032981, 'max': 0.9982269492903065}`
- GSPC BUY1 score describe: `{'count': 573.0, 'mean': 0.5633920761917821, 'std': 0.24700884270384385, 'min': 0.0011185682315336147, '25%': 0.3765120964318408, '50%': 0.5682174589518743, '75%': 0.7667269431083934, 'max': 0.9950166103017664}`

## Exemplos (20 datas)
| index_ticker | date | p_buy2 | p_buy0 | score |
|---|---|---:|---:|---:|
| ^BVSP | 2019-10-28 | 0.460643 | 0.491685 | 0.483702 |
| ^BVSP | 2019-10-29 | 0.529933 | 0.371951 | 0.587585 |
| ^BVSP | 2019-10-30 | 0.784922 | 0.192905 | 0.802721 |
| ^BVSP | 2019-10-31 | 0.436807 | 0.498337 | 0.467101 |
| ^BVSP | 2019-11-01 | 0.792683 | 0.256098 | 0.755814 |
| ^BVSP | 2019-11-04 | 0.415743 | 0.573725 | 0.420168 |
| ^BVSP | 2019-11-05 | 0.451774 | 0.498891 | 0.475219 |
| ^BVSP | 2019-11-06 | 0.618625 | 0.359202 | 0.632653 |
| ^BVSP | 2019-11-07 | 0.721175 | 0.194013 | 0.788007 |
| ^BVSP | 2019-11-08 | 0.348670 | 0.534922 | 0.394605 |
| ^GSPC | 2019-02-12 | 0.592018 | 0.264412 | 0.691262 |
| ^GSPC | 2019-02-13 | 0.158537 | 0.827605 | 0.160764 |
| ^GSPC | 2019-02-14 | 0.431818 | 0.584257 | 0.424986 |
| ^GSPC | 2019-02-15 | 0.457871 | 0.546009 | 0.456102 |
| ^GSPC | 2019-02-18 | 0.344789 | 0.724501 | 0.322447 |
| ^GSPC | 2019-02-19 | 0.482816 | 0.532705 | 0.475437 |
| ^GSPC | 2019-02-20 | 0.484479 | 0.482262 | 0.501147 |
| ^GSPC | 2019-02-21 | 0.499446 | 0.451220 | 0.525364 |
| ^GSPC | 2019-02-22 | 0.707317 | 0.184035 | 0.793532 |
| ^GSPC | 2019-02-25 | 0.518293 | 0.467295 | 0.525872 |

## Sanity checks do score
- corr(score, drawdown_t) BVSP: `0.297954`
- corr(score, drawdown_t) GSPC: `0.395437`

## Auditoria anti-leakage D-1 (30 datas)
| index_ticker | D | last_input_date_used | execution_price_date | ok_dminus1 |
|---|---|---|---|---|
| ^BVSP | 2018-09-27 | 2018-09-26 | 2018-09-27 | True |
| ^BVSP | 2019-04-10 | 2019-04-09 | 2019-04-10 | True |
| ^BVSP | 2019-10-14 | 2019-10-11 | 2019-10-14 | True |
| ^BVSP | 2020-04-24 | 2020-04-23 | 2020-04-24 | True |
| ^BVSP | 2020-10-27 | 2020-10-26 | 2020-10-27 | True |
| ^BVSP | 2021-05-11 | 2021-05-10 | 2021-05-11 | True |
| ^BVSP | 2021-11-16 | 2021-11-12 | 2021-11-16 | True |
| ^BVSP | 2022-05-24 | 2022-05-23 | 2022-05-24 | True |
| ^BVSP | 2022-11-25 | 2022-11-24 | 2022-11-25 | True |
| ^BVSP | 2023-06-02 | 2023-06-01 | 2023-06-02 | True |
| ^BVSP | 2023-12-07 | 2023-12-06 | 2023-12-07 | True |
| ^BVSP | 2024-06-14 | 2024-06-13 | 2024-06-14 | True |
| ^BVSP | 2024-12-16 | 2024-12-13 | 2024-12-16 | True |
| ^BVSP | 2025-06-27 | 2025-06-26 | 2025-06-27 | True |
| ^BVSP | 2025-12-30 | 2025-12-29 | 2025-12-30 | True |
| ^GSPC | 2018-09-27 | 2018-09-26 | 2018-09-27 | True |
| ^GSPC | 2019-04-10 | 2019-04-09 | 2019-04-10 | True |
| ^GSPC | 2019-10-14 | 2019-10-11 | 2019-10-14 | True |
| ^GSPC | 2020-04-24 | 2020-04-23 | 2020-04-24 | True |
| ^GSPC | 2020-10-27 | 2020-10-26 | 2020-10-27 | True |
| ^GSPC | 2021-05-11 | 2021-05-10 | 2021-05-11 | True |
| ^GSPC | 2021-11-16 | 2021-11-12 | 2021-11-16 | True |
| ^GSPC | 2022-05-24 | 2022-05-23 | 2022-05-24 | True |
| ^GSPC | 2022-11-25 | 2022-11-24 | 2022-11-25 | True |
| ^GSPC | 2023-06-02 | 2023-06-01 | 2023-06-02 | True |
| ^GSPC | 2023-12-07 | 2023-12-06 | 2023-12-07 | True |
| ^GSPC | 2024-06-14 | 2024-06-13 | 2024-06-14 | True |
| ^GSPC | 2024-12-16 | 2024-12-13 | 2024-12-16 | True |
| ^GSPC | 2025-06-27 | 2025-06-26 | 2025-06-27 | True |
| ^GSPC | 2025-12-30 | 2025-12-29 | 2025-12-30 | True |

## Source info
- `{"mode": "load_previous_outputs_003b", "missing_before": []}`

